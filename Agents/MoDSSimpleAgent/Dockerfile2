# First stage: build war file
#==================================================================================================
FROM maven:3.6.3-openjdk-17-slim AS builder

# Copy all files into root's home, including the source, pom file, ./m2 directory and credentials
ADD credentials /root/credentials
ADD .m2 /root/.m2

# 
WORKDIR /root/srm
RUN --mount=type=cache,target=/root/.m2/repository mvn org.apache.maven.plugins:maven-dependency-plugin:2.1:get \
    -DrepoUrl=all-cmcl-products \
    -Dartifact=com.cmclinnovations:srm-backend-linux:11.6.0:zip && \
	apt update && apt install unzip && \
	unzip /root/.m2/repository/com/cmclinnovations/srm-backend-linux/11.6.0/srm-backend-linux-11.6.0.zip -d ./
#==================================================================================================

# Second stage: copy the downloaded dependency into a new image and build into an app
#==================================================================================================
FROM ghcr.io/cambridge-cares/modssimpleagent:0.5.0-sampling-SNAPSHOT

ARG USER="user"
COPY --chown=${USER}:${USER} --from=builder /root/srm /usr/local/srm

WORKDIR /usr/local/mods-simple-agent